#!/bin/bash

FILE=$1
SDUMP_OPT="-f"
# MUDRAW_OPT="-o /dev/stdout -F png"
MUDRAW_OPT="-o - -F png"

INDEX=1 # page origin:1
PAGES=`mutool info $FILE | grep "^Pages:" | cut -d" " -f2 `
# WIN_HEIGHT=$(($(stty size |awk '{print $1}')*16)) # for fullscreen
WIN_HEIGHT=$(($(stty size |awk '{print $1}')*14))   # for tiling mode

tput civis
tput clear

echo "filename:$FILE page:$INDEX"
# mutool draw $MUDRAW_OPT $FILE $INDEX 2> /dev/null | sdump $SDUMP_OPT 2> /dev/null
# mutool draw $MUDRAW_OPT $FILE $INDEX 2> /dev/null | wezterm imgcat
# mutool draw $MUDRAW_OPT $FILE $INDEX 2> /dev/null | img2sixel --height=750
# mutool draw $MUDRAW_OPT $FILE $INDEX 2> /dev/null | img2sixel --height=$(kitty +icat --print-window-size | awk -F"x" '{print $2}')
mutool draw $MUDRAW_OPT $FILE $INDEX 2> /dev/null | img2sixel --height=$WIN_HEIGHT

while :; do
	read -s -n 1 KEY

	tput clear

	case "$KEY" in
	"j")
		INDEX=`expr $INDEX + 1`;;
	"J")
		INDEX=`expr $INDEX + 10`;;
	"k")
		INDEX=`expr $INDEX - 1`;;
	"K")
		INDEX=`expr $INDEX - 10`;;
	"g")
		INDEX=1;;
	"G")
		INDEX=$PAGES;;
	"q")
		tput cnorm
		exit 0;;
	esac

	if test $INDEX -lt "1"; then
		INDEX=$PAGES
	elif test $INDEX -gt $PAGES; then
		INDEX=1
	fi

	echo "filename:$FILE page:$INDEX"
	# mutool draw $MUDRAW_OPT $FILE $INDEX 2> /dev/null | sdump $SDUMP_OPT 2> /dev/null
	# mutool draw $MUDRAW_OPT $FILE $INDEX 2> /dev/null | wezterm imgcat
	# mutool draw $MUDRAW_OPT $FILE $INDEX 2> /dev/null | img2sixel --height=750
	# mutool draw $MUDRAW_OPT $FILE $INDEX 2> /dev/null | img2sixel --height=$(kitty +icat --print-window-size | awk -F"x" '{print $2}')
  mutool draw $MUDRAW_OPT $FILE $INDEX 2> /dev/null | img2sixel --height=$WIN_HEIGHT
done
